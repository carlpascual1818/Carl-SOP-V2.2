<!DOCTYPE html>
<html lang="en">
<head>
  <script src="config.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Internal Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #0D0D0D; --paper: #F7F4EF; --accent: #C8522A;
      --muted: #6B6560; --border: #E0DAD3; --tag-bg: #EDE8E2; --white: #fff;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'DM Sans',sans-serif; background:var(--paper); color:var(--ink); min-height:100vh; }
    .layout { display:flex; min-height:100vh; }

    .sidebar { width:260px; min-width:260px; background:var(--ink); color:#fff; padding:40px 28px; display:flex; flex-direction:column; gap:32px; position:sticky; top:0; height:100vh; overflow-y:auto; }
    .sidebar-logo { font-family:'DM Serif Display',serif; font-size:22px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:24px; }
    .sidebar-logo span { display:block; font-family:'DM Sans',sans-serif; font-size:11px; font-weight:600; letter-spacing:2px; text-transform:uppercase; color:rgba(255,255,255,0.35); margin-bottom:6px; }
    .sidebar-nav h4 { font-size:10px; font-weight:600; letter-spacing:2px; text-transform:uppercase; color:rgba(255,255,255,0.3); margin-bottom:10px; }
    .sidebar-nav ul { list-style:none; display:flex; flex-direction:column; gap:2px; }
    .sidebar-nav ul li a { display:block; padding:8px 12px; border-radius:6px; font-size:13.5px; color:rgba(255,255,255,0.6); text-decoration:none; transition:all 0.15s; cursor:pointer; }
    .sidebar-nav ul li a:hover { background:rgba(255,255,255,0.07); color:#fff; }
    .sidebar-nav ul li a.active { background:var(--accent); color:#fff; }
    .admin-link { display:block; padding:8px 12px; border-radius:6px; font-size:12px; color:rgba(255,255,255,0.3); text-decoration:none; text-align:center; border:1px solid rgba(255,255,255,0.1); transition:all 0.15s; margin-bottom:8px; }
    .admin-link:hover { color:rgba(255,255,255,0.7); border-color:rgba(255,255,255,0.3); }
    .btn-logout { display:block; padding:8px 12px; border-radius:6px; font-size:12px; background:none; color:rgba(255,255,255,0.4); border:1px solid rgba(255,255,255,0.1); font-family:'DM Sans',sans-serif; cursor:pointer; transition:all 0.15s; width:100%; }
    .btn-logout:hover { color:rgba(255,255,255,0.7); border-color:rgba(255,255,255,0.3); }
    .sidebar-user { margin-top:auto; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1); display:flex; align-items:center; gap:10px; margin-bottom:12px; }
    .sidebar-user .avatar { width:36px; height:36px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:600; color:#fff; flex-shrink:0; }
    .sidebar-user .uname { font-size:13px; font-weight:500; color:#fff; }
    .sidebar-user .urole { font-size:11px; color:rgba(255,255,255,0.4); margin-top:2px; }

    .main { flex:1; padding:64px 72px; max-width:860px; }
    .doc-eyebrow { font-size:11px; font-weight:600; letter-spacing:2.5px; text-transform:uppercase; color:var(--accent); margin-bottom:16px; }
    .doc-title { font-family:'DM Serif Display',serif; font-size:52px; line-height:1.05; letter-spacing:-1px; margin-bottom:12px; }
    .doc-subtitle { font-size:17px; color:var(--muted); line-height:1.6; max-width:560px; margin-bottom:36px; }
    .doc-meta { display:flex; gap:24px; padding:18px 0; border-top:1px solid var(--border); border-bottom:1px solid var(--border); margin-bottom:56px; flex-wrap:wrap; }
    .doc-meta-item label { display:block; font-size:10px; font-weight:600; letter-spacing:1.5px; text-transform:uppercase; color:var(--muted); margin-bottom:4px; }
    .doc-meta-item value { font-size:13.5px; font-weight:500; }

    .tab-content { display:none; }
    .tab-content.active { display:block; }

    .section { margin-bottom:64px; opacity:0; transform:translateY(14px); animation:fadeUp 0.45s forwards; }
    .section:nth-child(1){animation-delay:.05s} .section:nth-child(2){animation-delay:.1s} .section:nth-child(3){animation-delay:.15s} .section:nth-child(4){animation-delay:.2s} .section:nth-child(5){animation-delay:.25s} .section:nth-child(6){animation-delay:.3s} .section:nth-child(7){animation-delay:.35s}
    @keyframes fadeUp { to { opacity:1; transform:translateY(0); } }
    .section-header { display:flex; align-items:center; gap:14px; margin-bottom:24px; }
    .section-number { font-family:'DM Serif Display',serif; font-size:13px; color:var(--accent); min-width:24px; }
    .section-title { font-family:'DM Serif Display',serif; font-size:26px; letter-spacing:-0.3px; }
    .section-line { flex:1; height:1px; background:var(--border); }
    .body-text { font-size:15px; line-height:1.75; color:#2A2A2A; margin-bottom:16px; }

    .values-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    .value-card { background:var(--white); border:1px solid var(--border); border-radius:10px; padding:22px 24px; transition:box-shadow 0.2s; }
    .value-card:hover { box-shadow:0 4px 20px rgba(0,0,0,0.06); }
    .v-label { font-size:10px; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--accent); margin-bottom:8px; }
    .v-title { font-family:'DM Serif Display',serif; font-size:19px; margin-bottom:8px; }
    .v-desc { font-size:13.5px; color:var(--muted); line-height:1.6; }

    .org-chart { background:var(--white); border:1px solid var(--border); border-radius:12px; padding:32px; text-align:center; }
    .org-level { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-bottom:6px; }
    .org-connector { width:1px; height:22px; background:var(--border); margin:0 auto; }
    .org-node { background:var(--tag-bg); border:1.5px solid var(--border); border-radius:8px; padding:9px 14px; font-size:12px; font-weight:500; }
    .org-node.top { background:var(--ink); color:#fff; border-color:var(--ink); }
    .org-node.c-level { background:var(--accent); color:#fff; border-color:var(--accent); }
    .org-note { font-size:12px; color:var(--muted); margin-top:20px; }

    .tools-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    .tool-item { background:var(--white); border:1px solid var(--border); border-radius:8px; padding:14px 16px; display:flex; align-items:center; gap:10px; }
    .tool-icon { width:32px; height:32px; border-radius:6px; background:var(--tag-bg); display:flex; align-items:center; justify-content:center; font-size:16px; flex-shrink:0; }
    .tool-name { font-size:13.5px; font-weight:500; }
    .tool-desc { font-size:11.5px; color:var(--muted); }

    .policy-list { display:flex; flex-direction:column; gap:12px; }
    .policy-item { display:flex; align-items:flex-start; gap:14px; background:var(--white); border:1px solid var(--border); border-radius:8px; padding:16px 20px; }
    .policy-icon { font-size:18px; min-width:24px; margin-top:1px; }
    .policy-title { font-size:14px; font-weight:600; margin-bottom:4px; }
    .policy-desc { font-size:13px; color:var(--muted); line-height:1.55; }

    .philosophy-block { background:var(--ink); color:#fff; border-radius:12px; padding:40px; }
    .philosophy-block blockquote { font-family:'DM Serif Display',serif; font-size:26px; line-height:1.35; font-style:italic; margin-bottom:20px; }
    .philosophy-block p { font-size:14.5px; color:rgba(255,255,255,0.6); line-height:1.75; margin-bottom:12px; }

    .loading { display:flex; align-items:center; justify-content:center; min-height:100vh; font-size:15px; color:var(--muted); }

    @media(max-width:900px){ .sidebar{display:none} .main{padding:40px 24px} .values-grid,.tools-grid{grid-template-columns:1fr} }
  </style>
</head>
<body>

<div class="loading" id="loading">Loading...</div>

<div class="layout" id="app" style="display:none">
  <aside class="sidebar" id="sidebar"></aside>
  <main class="main">
    <!-- COMPANY OVERVIEW TAB -->
    <div class="tab-content active" id="tab-company-overview"></div>
    <!-- ORG CHART TAB -->
    <div class="tab-content" id="tab-org-chart">
      <div class="doc-eyebrow">Organization</div>
      <h1 class="doc-title">Org Chart</h1>
      <p class="doc-subtitle">Coming soon: Interactive drag-and-drop org chart builder with photos.</p>
    </div>
    <!-- TOOLS TAB -->
    <div class="tab-content" id="tab-tools">
      <div class="doc-eyebrow">Tools & Access</div>
      <h1 class="doc-title">Tools & Access</h1>
      <p class="doc-subtitle">Request access, view credentials, and learn about the tools we use.</p>
    </div>
    <!-- POLICIES TAB -->
    <div class="tab-content" id="tab-policies">
      <div class="doc-eyebrow">Policies</div>
      <h1 class="doc-title">Company Policies</h1>
      <p class="doc-subtitle">Leave policy, confidentiality, code of conduct, and escalation procedures.</p>
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = 'https://wkwgyoowhfhkyqwlufup.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indrd2d5b293aGZoa3lxd2x1ZnVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNDQwMTIsImV4cCI6MjA4NjkyMDAxMn0.ArSqtBC9K_268UnAfwTiqgYoJXGoXDmp1n9J2ISzgLE';

  const { createClient } = supabase;
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentUser = null;
  let sopData = {};

  const DEFAULTS = {
    company: { name:"[Company Name]", tagline:"Building brands that convert ‚Äî at scale.", lastUpdated:"February 2026", maintainedBy:"COO / Operations", version:"1.0" },
    whoWeAre: ["[Company Name] is a direct-to-consumer e-commerce company."],
    mission: { statement:"[Your mission statement]", vision:"In 3‚Äì5 years, [Company Name] will operate [X] brands." },
    values: [{ title:"Systems Over Heroics", desc:"If it depends on one person, it's broken." },{ title:"Ownership Mentality", desc:"Own your domain fully." }],
    org: { note:"Org chart with names coming soon.", levels:[["CEO","CEO"],["COO"],["CFO","Operations Manager"]] },
    tools: [{ icon:"üõçÔ∏è", name:"Shopify", desc:"Storefront" },{ icon:"üìò", name:"Facebook Ads", desc:"Paid ads" }],
    toolsNote:"Access granted by your manager or COO.",
    policies: [{ icon:"üïê", title:"Working Hours", desc:"Core hours TBD." }],
    philosophy: { quote:"[Your operating philosophy]", body:["This isn't built on hype."] },
  };

  const ROLES_HIERARCHY = {
    'CEO': ['CEO','COO','CFO','Operations Manager','CS Manager','Product Manager','Creative Manager','FB Ads Manager','Media Buyer','HR','Tech / Automations','CS','Dispute Specialist','Funnel Builder','Video Editor','VA'],
    'COO': ['COO','CFO','Operations Manager','CS Manager','Product Manager','Creative Manager','FB Ads Manager','Media Buyer','HR','Tech / Automations','CS','Dispute Specialist','Funnel Builder','Video Editor','VA'],
    'CFO': ['CFO','VA'],
    'Operations Manager': ['Operations Manager','CS Manager','Product Manager','Creative Manager','FB Ads Manager','Media Buyer','HR','Tech / Automations','CS','Dispute Specialist','Funnel Builder','Video Editor','VA'],
    'CS Manager': ['CS Manager','CS','Dispute Specialist'],
    'Product Manager': ['Product Manager','Funnel Builder'],
    'Creative Manager': ['Creative Manager','Video Editor'],
  };

  async function init() {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) {
      window.location.href = 'login.html';
      return;
    }

    const { data: users } = await supabaseClient.from('users').select('*').eq('email', session.user.email).single();
    currentUser = users || { name: session.user.email, role: 'Employee', email: session.user.email };

    const { data: content } = await supabaseClient.from('sop_content').select('*');
    if (content && content.length > 0) {
      content.forEach(row => {
        sopData[row.section] = row.content;
      });
    }

    // Get manual permissions
    const { data: manualPerms } = await supabaseClient
      .from('role_permissions')
      .select('role')
      .eq('user_email', currentUser.email)
      .eq('can_edit', true);
    
    let visibleRoles = ROLES_HIERARCHY[currentUser.role] || [currentUser.role];
    if (manualPerms && manualPerms.length > 0) {
      const manualRoles = manualPerms.map(p => p.role);
      visibleRoles = [...new Set([...visibleRoles, ...manualRoles])];
    }

    const C = { ...DEFAULTS, ...sopData };

    renderSidebar(C, visibleRoles);
    renderCompanyOverview(C);

    document.getElementById('loading').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
  }

  function initials(name) {
    return name.replace(/[\[\]]/g,'').split(' ').map(n=>n[0]||'').join('').toUpperCase().slice(0,2)||'?';
  }

  function renderSidebar(C, visibleRoles) {
    const showAdmin = currentUser.role === 'CEO' || currentUser.role === 'COO';
    const adminLink = showAdmin ? `<a class="admin-link" href="admin.html">‚öôÔ∏è Admin</a>` : '';

    const departmentLinks = visibleRoles.map(r => `<li><a href="role.html?role=${encodeURIComponent(r)}">${r}</a></li>`).join('');

    document.getElementById('sidebar').innerHTML = `
      <div class="sidebar-logo"><span>Internal Portal</span>${C.company.name}</div>
      <nav class="sidebar-nav">
        <h4>General</h4>
        <ul>
          <li><a class="active" onclick="showTab('company-overview')">Company Overview</a></li>
          <li><a onclick="showTab('org-chart')">Org Chart</a></li>
          <li><a onclick="showTab('tools')">Tools & Access</a></li>
          <li><a onclick="showTab('policies')">Policies</a></li>
        </ul>
      </nav>
      <nav class="sidebar-nav">
        <h4>My Role</h4>
        <ul>
          <li><a href="role.html?role=${encodeURIComponent(currentUser.role)}">View My Role</a></li>
        </ul>
      </nav>
      <nav class="sidebar-nav">
        <h4>Departments</h4>
        <ul>${departmentLinks}</ul>
      </nav>
      <div style="margin-top:auto">
        ${adminLink}
        <button class="btn-logout" onclick="logout()">Sign Out</button>
      </div>
      <div class="sidebar-user">
        <div class="avatar">${initials(currentUser.name)}</div>
        <div><div class="uname">${currentUser.name}</div><div class="urole">${currentUser.role}</div></div>
      </div>
    `;
  }

  function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-'+tabName).classList.add('active');
    document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
    event.target.classList.add('active');
  }

  function renderCompanyOverview(C) {
    document.getElementById('tab-company-overview').innerHTML = `
      <div class="doc-eyebrow">Company Overview</div>
      <h1 class="doc-title">Welcome to<br>${C.company.name}.</h1>
      <p class="doc-subtitle">${C.company.tagline}</p>
      <div class="doc-meta">
        <div class="doc-meta-item"><label>Last Updated</label><value>${C.company.lastUpdated}</value></div>
        <div class="doc-meta-item"><label>Maintained By</label><value>${C.company.maintainedBy}</value></div>
        <div class="doc-meta-item"><label>Version</label><value>${C.company.version}</value></div>
      </div>

      <div class="section">
        <div class="section-header"><span class="section-number">01</span><h2 class="section-title">Who We Are</h2><div class="section-line"></div></div>
        ${C.whoWeAre.map(p=>`<p class="body-text">${p}</p>`).join('')}
      </div>

      <div class="section">
        <div class="section-header"><span class="section-number">02</span><h2 class="section-title">Mission & Vision</h2><div class="section-line"></div></div>
        <div class="philosophy-block">
          <blockquote>"${C.mission.statement}"</blockquote>
          <p>${C.mission.vision}</p>
        </div>
      </div>

      <div class="section">
        <div class="section-header"><span class="section-number">03</span><h2 class="section-title">How We Operate</h2><div class="section-line"></div></div>
        <div class="values-grid">
          ${C.values.map((v,i)=>`
            <div class="value-card">
              <div class="v-label">Value ${String(i+1).padStart(2,'0')}</div>
              <div class="v-title">${v.title}</div>
              <div class="v-desc">${v.desc}</div>
            </div>`).join('')}
        </div>
      </div>

      <div class="section">
        <div class="section-header"><span class="section-number">04</span><h2 class="section-title">Philosophy</h2><div class="section-line"></div></div>
        <div class="philosophy-block">
          <blockquote>"${C.philosophy.quote}"</blockquote>
          ${C.philosophy.body.map(p=>`<p>${p}</p>`).join('')}
        </div>
      </div>
    `;
  }

  async function logout() {
    await supabaseClient.auth.signOut();
    window.location.href = 'login.html';
  }

  init();
</script>
</body>
</html>
